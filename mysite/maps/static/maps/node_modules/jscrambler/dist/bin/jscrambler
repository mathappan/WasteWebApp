#!/usr/bin/env node
'use strict';

require('babel-polyfill');

var _commander = require('commander');

var _commander2 = _interopRequireDefault(_commander);

var _lodash = require('lodash.defaults');

var _lodash2 = _interopRequireDefault(_lodash);

var _glob = require('glob');

var _glob2 = _interopRequireDefault(_glob);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _config3 = require('../lib/config');

var _config4 = _interopRequireDefault(_config3);

var _lib = require('../lib');

var _lib2 = _interopRequireDefault(_lib);

var _cli = require('../lib/cli');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

var debug = !!process.env.DEBUG;

_commander2.default.version(require('../../package.json').version).usage('[options] <file ...>').option('-a, --access-key <accessKey>', 'Access key').option('-c, --config <config>', 'JScrambler configuration options').option('-H, --host <host>', 'Hostname').option('-i, --application-id <id>', 'Application ID').option('-o, --output-dir <dir>', 'Output directory').option('-p, --port <port>', 'Port').option('--protocol <protocol>', 'Protocol (http or https)').option('--cafile <path>', 'Internal certificate authority').option('-C, --cwd <dir>', 'Current Working Directory').option('-s, --secret-key <secretKey>', 'Secret key').option('-m, --source-maps <id>', 'Download source maps').option('-R, --randomization-seed <seed>', 'Set randomization seed').option('--recommended-order <bool>', 'Use recommended order').option('-W --werror', 'Cancel protection if any file contains errors').option('--jscramblerVersion <version>', 'Use a specific Jscrambler version').parse(process.argv);

var globSrc, filesSrc, config;

// If -c, --config file was provided
if (_commander2.default.config) {
  // We're using `commander` (CLI) as the source of all truths, falling back to
  // the `config` provided by the file passed as argument
  config = require(_path2.default.resolve(_commander2.default.config, '.'));
} else {
  config = {};
}

config.accessKey = _commander2.default.accessKey || (config.keys ? config.keys.accessKey : void 0);
config.secretKey = _commander2.default.secretKey || (config.keys ? config.keys.secretKey : void 0);
config.host = _commander2.default.host || config.host;
config.port = _commander2.default.port || config.port;
config.port = config.port && parseInt(config.port);
config.protocol = _commander2.default.protocol || config.protocol;
config.cafile = _commander2.default.cafile || config.cafile;
config.filesDest = _commander2.default.outputDir || config.filesDest;
config.applicationId = _commander2.default.applicationId || config.applicationId;
config.randomizationSeed = _commander2.default.randomizationSeed || config.randomizationSeed;
config.cwd = _commander2.default.cwd || config.cwd;
config.useRecommendedOrder = _commander2.default.recommendedOrder ? _commander2.default.recommendedOrder !== 'false' ? true : false : config.useRecommendedOrder;
config.werror = _commander2.default.werror || config.werror;
config.jscramblerVersion = _commander2.default.jscramblerVersion || config.jscramblerVersion;

if (config.jscramblerVersion && !/^\d+\.\d+$/.test(config.jscramblerVersion)) {
  console.error('The Jscrambler version must be in the form of $major.$minor (e.g., 5.1)');
  process.exit(1);
}

config = (0, _lodash2.default)(config, _config4.default);

globSrc = config.filesSrc;
// If src paths have been provided
if (_commander2.default.args.length > 0) {
  globSrc = _commander2.default.args;
}

if (globSrc && globSrc.length) {
  filesSrc = [];
  // Iterate `globSrc` to build a list of source files into `filesSrc`
  for (var i = 0, l = globSrc.length; i < l; ++i) {
    // Calling sync `glob` because async is pointless for the CLI use case
    // (as of now at least)

    // If the user is providing a zip alongside more files
    if (_path2.default.extname(globSrc[i]) === '.zip' && globSrc.length > 1) {
      console.error('Please either provide a zip file containing all your source files or use the minimatch syntax');
      process.exit(1);
    }

    var tmpGlob = _glob2.default.sync(globSrc[i], {
      dot: true
    });

    if (debug) {
      if (tmpGlob.length === 0) {
        console.log('Pattern "' + globSrc[i] + '" doesn\'t match any files. Will be ignored.');
      } else {
        console.log('Pattern "' + globSrc[i] + '" matched the following files:');
        tmpGlob.forEach(function (file) {
          console.log('    ' + file);
        });
      }
    }
    filesSrc = filesSrc.concat(tmpGlob);
  }
}

var _config2 = config,
    applicationId = _config2.applicationId,
    accessKey = _config2.accessKey,
    secretKey = _config2.secretKey,
    filesDest = _config2.filesDest,
    host = _config2.host,
    port = _config2.port,
    protocol = _config2.protocol,
    cafile = _config2.cafile,
    applicationTypes = _config2.applicationTypes,
    languageSpecifications = _config2.languageSpecifications,
    areSubscribersOrdered = _config2.areSubscribersOrdered,
    cwd = _config2.cwd,
    randomizationSeed = _config2.randomizationSeed,
    _config2$sourceMaps = _config2.sourceMaps,
    sourceMaps = _config2$sourceMaps === undefined ? false : _config2$sourceMaps,
    useRecommendedOrder = _config2.useRecommendedOrder,
    werror = _config2.werror,
    jscramblerVersion = _config2.jscramblerVersion;


var params = (0, _cli.mergeAndParseParams)(_commander2.default, config.params);

if (_commander2.default.sourceMaps) {
  // Go, go, go download
  _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {
    return regeneratorRuntime.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _context.prev = 0;
            _context.next = 3;
            return _lib2.default.downloadSourceMaps({
              keys: {
                accessKey: accessKey,
                secretKey: secretKey
              },
              host: host,
              port: port,
              protocol: protocol,
              cafile: cafile,
              filesDest: filesDest,
              filesSrc: filesSrc,
              protectionId: _commander2.default.sourceMaps
            });

          case 3:
            _context.next = 9;
            break;

          case 5:
            _context.prev = 5;
            _context.t0 = _context['catch'](0);

            console.error(_context.t0);
            process.exit(1);

          case 9:
          case 'end':
            return _context.stop();
        }
      }
    }, _callee, undefined, [[0, 5]]);
  }))();
} else {
  // Go, go, go
  _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {
    var protectAndDownloadOptions;
    return regeneratorRuntime.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            _context2.prev = 0;
            protectAndDownloadOptions = {
              keys: {
                accessKey: accessKey,
                secretKey: secretKey
              },
              host: host,
              port: port,
              protocol: protocol,
              cafile: cafile,
              applicationId: applicationId,
              filesSrc: filesSrc,
              filesDest: filesDest,
              params: params,
              applicationTypes: applicationTypes,
              languageSpecifications: languageSpecifications,
              areSubscribersOrdered: areSubscribersOrdered,
              cwd: cwd,
              sourceMaps: sourceMaps,
              randomizationSeed: randomizationSeed,
              useRecommendedOrder: useRecommendedOrder,
              jscramblerVersion: jscramblerVersion
            };


            if (typeof werror !== 'undefined') {
              protectAndDownloadOptions.bail = werror;
            }
            _context2.next = 5;
            return _lib2.default.protectAndDownload(protectAndDownloadOptions);

          case 5:
            _context2.next = 11;
            break;

          case 7:
            _context2.prev = 7;
            _context2.t0 = _context2['catch'](0);

            console.error(_context2.t0.message || _context2.t0);
            process.exit(1);

          case 11:
          case 'end':
            return _context2.stop();
        }
      }
    }, _callee2, undefined, [[0, 7]]);
  }))();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9iaW4vanNjcmFtYmxlciJdLCJuYW1lcyI6WyJkZWJ1ZyIsInByb2Nlc3MiLCJlbnYiLCJERUJVRyIsInZlcnNpb24iLCJyZXF1aXJlIiwidXNhZ2UiLCJvcHRpb24iLCJwYXJzZSIsImFyZ3YiLCJnbG9iU3JjIiwiZmlsZXNTcmMiLCJjb25maWciLCJyZXNvbHZlIiwiYWNjZXNzS2V5Iiwia2V5cyIsInNlY3JldEtleSIsImhvc3QiLCJwb3J0IiwicGFyc2VJbnQiLCJwcm90b2NvbCIsImNhZmlsZSIsImZpbGVzRGVzdCIsIm91dHB1dERpciIsImFwcGxpY2F0aW9uSWQiLCJyYW5kb21pemF0aW9uU2VlZCIsImN3ZCIsInVzZVJlY29tbWVuZGVkT3JkZXIiLCJyZWNvbW1lbmRlZE9yZGVyIiwid2Vycm9yIiwianNjcmFtYmxlclZlcnNpb24iLCJ0ZXN0IiwiY29uc29sZSIsImVycm9yIiwiZXhpdCIsImFyZ3MiLCJsZW5ndGgiLCJpIiwibCIsImV4dG5hbWUiLCJ0bXBHbG9iIiwic3luYyIsImRvdCIsImxvZyIsImZvckVhY2giLCJmaWxlIiwiY29uY2F0IiwiYXBwbGljYXRpb25UeXBlcyIsImxhbmd1YWdlU3BlY2lmaWNhdGlvbnMiLCJhcmVTdWJzY3JpYmVyc09yZGVyZWQiLCJzb3VyY2VNYXBzIiwicGFyYW1zIiwiZG93bmxvYWRTb3VyY2VNYXBzIiwicHJvdGVjdGlvbklkIiwicHJvdGVjdEFuZERvd25sb2FkT3B0aW9ucyIsImJhaWwiLCJwcm90ZWN0QW5kRG93bmxvYWQiLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiOztBQUVBOztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQSxJQUFNQSxRQUFRLENBQUMsQ0FBQ0MsUUFBUUMsR0FBUixDQUFZQyxLQUE1Qjs7QUFFQSxvQkFDR0MsT0FESCxDQUNXQyxRQUFRLG9CQUFSLEVBQThCRCxPQUR6QyxFQUVHRSxLQUZILENB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TGdDO0FBTWhDQyx3QkFOZ0M7QUFPaENFLGdDQVBnQztBQVFoQ0MsNEJBUmdDO0FBU2hDRywwQ0FUZ0M7QUFVaENiLGdDQVZnQztBQVdoQ1csa0NBWGdDO0FBWWhDNkIsNEJBWmdDO0FBYWhDSixnREFiZ0M7QUFjaENDLDREQWRnQztBQWVoQ0MsMERBZmdDO0FBZ0JoQ3ZCLHNCQWhCZ0M7QUFpQmhDd0Isb0NBakJnQztBQWtCaEN6QixrREFsQmdDO0FBbUJoQ0Usc0RBbkJnQztBQW9CaENHO0FBcEJnQyxhQUZyQzs7O0FBeUJHLGdCQUFJLE9BQU9ELE1BQVAsS0FBa0IsV0FBdEIsRUFBbUM7QUFDakN5Qix3Q0FBMEJDLElBQTFCLEdBQWlDMUIsTUFBakM7QUFDRDtBQTNCSjtBQUFBLG1CQTRCUyxjQUNIMkIsa0JBREcsQ0FDZ0JGLHlCQURoQixDQTVCVDs7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFBQTtBQUFBOztBQStCR3RCLG9CQUFRQyxLQUFSLENBQWMsYUFBTXdCLE9BQU4sZ0JBQWQ7QUFDQXhELG9CQUFRaUMsSUFBUixDQUFhLENBQWI7O0FBaENIO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEdBQUQ7QUFtQ0QiLCJmaWxlIjoianNjcmFtYmxlciIsInNvdXJjZXNDb250ZW50IjpbIlxuXG5pbXBvcnQgJ2JhYmVsLXBvbHlmaWxsJztcblxuaW1wb3J0IGNvbW1hbmRlciBmcm9tICdjb21tYW5kZXInO1xuaW1wb3J0IGRlZmF1bHRzIGZyb20gJ2xvZGFzaC5kZWZhdWx0cyc7XG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgX2NvbmZpZyBmcm9tICcuLi9saWIvY29uZmlnJztcbmltcG9ydCBqU2NyYW1ibGVyIGZyb20gJy4uL2xpYic7XG5pbXBvcnQge21lcmdlQW5kUGFyc2VQYXJhbXN9IGZyb20gJy4uL2xpYi9jbGknO1xuXG5jb25zdCBkZWJ1ZyA9ICEhcHJvY2Vzcy5lbnYuREVCVUc7XG5cbmNvbW1hbmRlclxuICAudmVyc2lvbihyZXF1aXJlKCcuLi8uLi9wYWNrYWdlLmpzb24nKS52ZXJzaW9uKVxuICAudXNhZ2UoJ1tvcHRpb25zXSA8ZmlsZSAuLi4+JylcbiAgLm9wdGlvbignLWEsIC0tYWNjZXNzLWtleSA8YWNjZXNzS2V5PicsICdBY2Nlc3Mga2V5JylcbiAgLm9wdGlvbignLWMsIC0tY29uZmlnIDxjb25maWc+JywgJ0pTY3JhbWJsZXIgY29uZmlndXJhdGlvbiBvcHRpb25zJylcbiAgLm9wdGlvbignLUgsIC0taG9zdCA8aG9zdD4nLCAnSG9zdG5hbWUnKVxuICAub3B0aW9uKCctaSwgLS1hcHBsaWNhdGlvbi1pZCA8aWQ+JywgJ0FwcGxpY2F0aW9uIElEJylcbiAgLm9wdGlvbignLW8sIC0tb3V0cHV0LWRpciA8ZGlyPicsICdPdXRwdXQgZGlyZWN0b3J5JylcbiAgLm9wdGlvbignLXAsIC0tcG9ydCA8cG9ydD4nLCAnUG9ydCcpXG4gIC5vcHRpb24oJy0tcHJvdG9jb2wgPHByb3RvY29sPicsICdQcm90b2NvbCAoaHR0cCBvciBodHRwcyknKVxuICAub3B0aW9uKCctLWNhZmlsZSA8cGF0aD4nLCAnSW50ZXJuYWwgY2VydGlmaWNhdGUgYXV0aG9yaXR5JylcbiAgLm9wdGlvbignLUMsIC0tY3dkIDxkaXI+JywgJ0N1cnJlbnQgV29ya2luZyBEaXJlY3RvcnknKVxuICAub3B0aW9uKCctcywgLS1zZWNyZXQta2V5IDxzZWNyZXRLZXk+JywgJ1NlY3JldCBrZXknKVxuICAub3B0aW9uKCctbSwgLS1zb3VyY2UtbWFwcyA8aWQ+JywgJ0Rvd25sb2FkIHNvdXJjZSBtYXBzJylcbiAgLm9wdGlvbignLVIsIC0tcmFuZG9taXphdGlvbi1zZWVkIDxzZWVkPicsICdTZXQgcmFuZG9taXphdGlvbiBzZWVkJylcbiAgLm9wdGlvbignLS1yZWNvbW1lbmRlZC1vcmRlciA8Ym9vbD4nLCAnVXNlIHJlY29tbWVuZGVkIG9yZGVyJylcbiAgLm9wdGlvbignLVcgLS13ZXJyb3InLCAnQ2FuY2VsIHByb3RlY3Rpb24gaWYgYW55IGZpbGUgY29udGFpbnMgZXJyb3JzJylcbiAgLm9wdGlvbignLS1qc2NyYW1ibGVyVmVyc2lvbiA8dmVyc2lvbj4nLCAnVXNlIGEgc3BlY2lmaWMgSnNjcmFtYmxlciB2ZXJzaW9uJylcbiAgLnBhcnNlKHByb2Nlc3MuYXJndik7XG5cbnZhciBnbG9iU3JjLCBmaWxlc1NyYywgY29uZmlnO1xuXG4vLyBJZiAtYywgLS1jb25maWcgZmlsZSB3YXMgcHJvdmlkZWRcbmlmIChjb21tYW5kZXIuY29uZmlnKSB7XG4gIC8vIFdlJ3JlIHVzaW5nIGBjb21tYW5kZXJgIChDTEkpIGFzIHRoZSBzb3VyY2Ugb2YgYWxsIHRydXRocywgZmFsbGluZyBiYWNrIHRvXG4gIC8vIHRoZSBgY29uZmlnYCBwcm92aWRlZCBieSB0aGUgZmlsZSBwYXNzZWQgYXMgYXJndW1lbnRcbiAgY29uZmlnID0gcmVxdWlyZShwYXRoLnJlc29sdmUoY29tbWFuZGVyLmNvbmZpZywgJy4nKSk7XG59IGVsc2Uge1xuICBjb25maWcgPSB7fTtcbn1cblxuY29uZmlnLmFjY2Vzc0tleSA9IGNvbW1hbmRlci5hY2Nlc3NLZXkgfHwgKGNvbmZpZy5rZXlzID8gY29uZmlnLmtleXMuYWNjZXNzS2V5IDogdm9pZCAwKTtcbmNvbmZpZy5zZWNyZXRLZXkgPSBjb21tYW5kZXIuc2VjcmV0S2V5IHx8IChjb25maWcua2V5cyA/IGNvbmZpZy5rZXlzLnNlY3JldEtleSA6IHZvaWQgMCk7XG5jb25maWcuaG9zdCA9IGNvbW1hbmRlci5ob3N0IHx8IGNvbmZpZy5ob3N0O1xuY29uZmlnLnBvcnQgPSBjb21tYW5kZXIucG9ydCB8fCBjb25maWcucG9ydDtcbmNvbmZpZy5wb3J0ID0gY29uZmlnLnBvcnQgJiYgcGFyc2VJbnQoY29uZmlnLnBvcnQpO1xuY29uZmlnLnByb3RvY29sID0gY29tbWFuZGVyLnByb3RvY29sIHx8IGNvbmZpZy5wcm90b2NvbDtcbmNvbmZpZy5jYWZpbGUgPSBjb21tYW5kZXIuY2FmaWxlIHx8IGNvbmZpZy5jYWZpbGU7XG5jb25maWcuZmlsZXNEZXN0ID0gY29tbWFuZGVyLm91dHB1dERpciB8fCBjb25maWcuZmlsZXNEZXN0O1xuY29uZmlnLmFwcGxpY2F0aW9uSWQgPSBjb21tYW5kZXIuYXBwbGljYXRpb25JZCB8fCBjb25maWcuYXBwbGljYXRpb25JZDtcbmNvbmZpZy5yYW5kb21pemF0aW9uU2VlZCA9IGNvbW1hbmRlci5yYW5kb21pemF0aW9uU2VlZCB8fCBjb25maWcucmFuZG9taXphdGlvblNlZWQ7XG5jb25maWcuY3dkID0gY29tbWFuZGVyLmN3ZCB8fCBjb25maWcuY3dkO1xuY29uZmlnLnVzZVJlY29tbWVuZGVkT3JkZXIgPSBjb21tYW5kZXIucmVjb21tZW5kZWRPcmRlciA/IChjb21tYW5kZXIucmVjb21tZW5kZWRPcmRlciAhPT0gJ2ZhbHNlJyA/IHRydWUgOiBmYWxzZSkgOiBjb25maWcudXNlUmVjb21tZW5kZWRPcmRlcjtcbmNvbmZpZy53ZXJyb3IgPSBjb21tYW5kZXIud2Vycm9yIHx8IGNvbmZpZy53ZXJyb3I7XG5jb25maWcuanNjcmFtYmxlclZlcnNpb24gPSBjb21tYW5kZXIuanNjcmFtYmxlclZlcnNpb24gfHwgY29uZmlnLmpzY3JhbWJsZXJWZXJzaW9uO1xuXG5pZiAoY29uZmlnLmpzY3JhbWJsZXJWZXJzaW9uICYmICEvXlxcZCtcXC5cXGQrJC8udGVzdChjb25maWcuanNjcmFtYmxlclZlcnNpb24pKSB7XG4gIGNvbnNvbGUuZXJyb3IoJ1RoZSBKc2NyYW1ibGVyIHZlcnNpb24gbXVzdCBiZSBpbiB0aGUgZm9ybSBvZiAkbWFqb3IuJG1pbm9yIChlLmcuLCA1LjEpJyk7XG4gIHByb2Nlc3MuZXhpdCgxKTtcbn1cblxuY29uZmlnID0gZGVmYXVsdHMoY29uZmlnLCBfY29uZmlnKTtcblxuZ2xvYlNyYyA9IGNvbmZpZy5maWxlc1NyYztcbi8vIElmIHNyYyBwYXRocyBoYXZlIGJlZW4gcHJvdmlkZWRcbmlmIChjb21tYW5kZXIuYXJncy5sZW5ndGggPiAwKSB7XG4gIGdsb2JTcmMgPSBjb21tYW5kZXIuYXJncztcbn1cblxuaWYgKGdsb2JTcmMgJiYgZ2xvYlNyYy5sZW5ndGgpIHtcbiAgZmlsZXNTcmMgPSBbXTtcbiAgLy8gSXRlcmF0ZSBgZ2xvYlNyY2AgdG8gYnVpbGQgYSBsaXN0IG9mIHNvdXJjZSBmaWxlcyBpbnRvIGBmaWxlc1NyY2BcbiAgZm9yIChsZXQgaSA9IDAsIGwgPSBnbG9iU3JjLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgIC8vIENhbGxpbmcgc3luYyBgZ2xvYmAgYmVjYXVzZSBhc3luYyBpcyBwb2ludGxlc3MgZm9yIHRoZSBDTEkgdXNlIGNhc2VcbiAgICAvLyAoYXMgb2Ygbm93IGF0IGxlYXN0KVxuXG4gICAgLy8gSWYgdGhlIHVzZXIgaXMgcHJvdmlkaW5nIGEgemlwIGFsb25nc2lkZSBtb3JlIGZpbGVzXG4gICAgaWYgKHBhdGguZXh0bmFtZShnbG9iU3JjW2ldKSA9PT0gJy56aXAnICYmIGdsb2JTcmMubGVuZ3RoID4gMSkge1xuICAgICAgY29uc29sZS5lcnJvcignUGxlYXNlIGVpdGhlciBwcm92aWRlIGEgemlwIGZpbGUgY29udGFpbmluZyBhbGwgeW91ciBzb3VyY2UgZmlsZXMgb3IgdXNlIHRoZSBtaW5pbWF0Y2ggc3ludGF4Jyk7XG4gICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgfVxuXG4gICAgY29uc3QgdG1wR2xvYiA9IGdsb2Iuc3luYyhnbG9iU3JjW2ldLCB7XG4gICAgICBkb3Q6IHRydWVcbiAgICB9KTtcblxuICAgIGlmIChkZWJ1Zykge1xuICAgICAgaWYgKHRtcEdsb2IubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBQYXR0ZXJuIFwiJHtnbG9iU3JjW2ldfVwiIGRvZXNuJ3QgbWF0Y2ggYW55IGZpbGVzLiBXaWxsIGJlIGlnbm9yZWQuYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhgUGF0dGVybiBcIiR7Z2xvYlNyY1tpXX1cIiBtYXRjaGVkIHRoZSBmb2xsb3dpbmcgZmlsZXM6YCk7XG4gICAgICAgIHRtcEdsb2IuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgICAgICR7ZmlsZX1gKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIGZpbGVzU3JjID0gZmlsZXNTcmMuY29uY2F0KHRtcEdsb2IpO1xuICB9XG59XG5cbmNvbnN0IHtcbiAgYXBwbGljYXRpb25JZCxcbiAgYWNjZXNzS2V5LFxuICBzZWNyZXRLZXksXG4gIGZpbGVzRGVzdCxcbiAgaG9zdCxcbiAgcG9ydCxcbiAgcHJvdG9jb2wsXG4gIGNhZmlsZSxcbiAgYXBwbGljYXRpb25UeXBlcyxcbiAgbGFuZ3VhZ2VTcGVjaWZpY2F0aW9ucyxcbiAgYXJlU3Vic2NyaWJlcnNPcmRlcmVkLFxuICBjd2QsXG4gIHJhbmRvbWl6YXRpb25TZWVkLFxuICBzb3VyY2VNYXBzID0gZmFsc2UsXG4gIHVzZVJlY29tbWVuZGVkT3JkZXIsXG4gIHdlcnJvcixcbiAganNjcmFtYmxlclZlcnNpb25cbn0gPSBjb25maWc7XG5cbmNvbnN0IHBhcmFtcyA9IG1lcmdlQW5kUGFyc2VQYXJhbXMoY29tbWFuZGVyLCBjb25maWcucGFyYW1zKTtcblxuaWYgKGNvbW1hbmRlci5zb3VyY2VNYXBzKSB7XG4gIC8vIEdvLCBnbywgZ28gZG93bmxvYWRcbiAgKGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgalNjcmFtYmxlclxuICAgICAgICAuZG93bmxvYWRTb3VyY2VNYXBzKHtcbiAgICAgICAgICBrZXlzOiB7XG4gICAgICAgICAgICBhY2Nlc3NLZXksXG4gICAgICAgICAgICBzZWNyZXRLZXlcbiAgICAgICAgICB9LFxuICAgICAgICAgIGhvc3QsXG4gICAgICAgICAgcG9ydCxcbiAgICAgICAgICBwcm90b2NvbCxcbiAgICAgICAgICBjYWZpbGUsXG4gICAgICAgICAgZmlsZXNEZXN0LFxuICAgICAgICAgIGZpbGVzU3JjLFxuICAgICAgICAgIHByb3RlY3Rpb25JZDogY29tbWFuZGVyLnNvdXJjZU1hcHNcbiAgICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgfSkoKTtcbn0gZWxzZSB7XG4gIC8vIEdvLCBnbywgZ29cbiAgKGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcHJvdGVjdEFuZERvd25sb2FkT3B0aW9ucyA9IHtcbiAgICAgICAga2V5czoge1xuICAgICAgICAgIGFjY2Vzc0tleSxcbiAgICAgICAgICBzZWNyZXRLZXlcbiAgICAgICAgfSxcbiAgICAgICAgaG9zdCxcbiAgICAgICAgcG9ydCxcbiAgICAgICAgcHJvdG9jb2wsXG4gICAgICAgIGNhZmlsZSxcbiAgICAgICAgYXBwbGljYXRpb25JZCxcbiAgICAgICAgZmlsZXNTcmMsXG4gICAgICAgIGZpbGVzRGVzdCxcbiAgICAgICAgcGFyYW1zLFxuICAgICAgICBhcHBsaWNhdGlvblR5cGVzLFxuICAgICAgICBsYW5ndWFnZVNwZWNpZmljYXRpb25zLFxuICAgICAgICBhcmVTdWJzY3JpYmVyc09yZGVyZWQsXG4gICAgICAgIGN3ZCxcbiAgICAgICAgc291cmNlTWFwcyxcbiAgICAgICAgcmFuZG9taXphdGlvblNlZWQsXG4gICAgICAgIHVzZVJlY29tbWVuZGVkT3JkZXIsXG4gICAgICAgIGpzY3JhbWJsZXJWZXJzaW9uXG4gICAgICB9O1xuXG4gICAgICBpZiAodHlwZW9mIHdlcnJvciAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgcHJvdGVjdEFuZERvd25sb2FkT3B0aW9ucy5iYWlsID0gd2Vycm9yO1xuICAgICAgfVxuICAgICAgYXdhaXQgalNjcmFtYmxlclxuICAgICAgICAucHJvdGVjdEFuZERvd25sb2FkKHByb3RlY3RBbmREb3dubG9hZE9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yLm1lc3NhZ2UgfHwgZXJyb3IpO1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgfSkoKTtcbn1cbiJdfQ==
